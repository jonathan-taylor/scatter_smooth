{"version":3,"kind":"Notebook","sha256":"e9ba263cde416dc0a6b8c508197a18e82264532809f5e3b7b8742ee8d7cccdc8","slug":"compare-cpp","location":"/compare_cpp.md","dependencies":[],"frontmatter":{"title":"Performance Comparison: Pure Python vs C++ Extension","kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"jupytext":{"formats":"md:myst","text_representation":{"extension":".md","format_name":"myst","format_version":"0.13","jupytext_version":"1.19.1"}},"content_includes_title":false,"authors":[{"nameParsed":{"literal":"Jonathan Taylor","given":"Jonathan","family":"Taylor"},"name":"Jonathan Taylor","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/executablebooks/jupyter-book","source_url":"https://github.com/executablebooks/jupyter-book/blob/main/docs/compare_cpp.md","edit_url":"https://github.com/executablebooks/jupyter-book/edit/main/docs/compare_cpp.md","exports":[{"format":"md","filename":"compare_cpp.md","url":"https://jonathan-taylor.github.io/smoothing_spline//build/compare_cpp-5e9d28ce35977faa142be997d2408cca.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"This document compares the computational performance of the pure Python implementation (","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"BB2onK5soq"},{"type":"inlineCode","value":"SplineFitterPy","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"IJEJVLtQoc"},{"type":"text","value":") and the C++ optimized implementation (","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"KtuICOAY2z"},{"type":"inlineCode","value":"SplineFitter","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"XZU61pY35d"},{"type":"text","value":") of the smoothing spline fitter.","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"gct5mZDiNo"}],"key":"hRN6VR2Okc"},{"type":"heading","depth":2,"position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Setup","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"ZiOHHASwaX"}],"identifier":"setup","label":"Setup","html_id":"setup","implicit":true,"key":"WDbMkrVL7o"}],"key":"kI9UqOP7TU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport matplotlib.pyplot as plt\nimport time\nimport sys\nimport os\n\n# Ensure we can import from tests\nsys.path.append(os.path.abspath('..'))\n\nfrom smoothing_spline.fitter import SplineFitter\ntry:\n    from tests.spline_fitter import SplineFitter as SplineFitterPy\nexcept ImportError:\n    print(\"Could not import pure Python SplineFitter from tests.\")\n    SplineFitterPy = None","key":"HqmUMChjQu"},{"type":"outputs","id":"SDWfvwczpqzGP9SI35DHD","children":[],"key":"ILdM65hE1f"}],"key":"rM1WHev9Db"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"Speed Comparison at Different Scales","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"MIYCHiyulu"}],"identifier":"speed-comparison-at-different-scales","label":"Speed Comparison at Different Scales","html_id":"speed-comparison-at-different-scales","implicit":true,"key":"POer9c32cl"},{"type":"paragraph","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"We will measure the time taken to fit the smoothing spline for different numbers of observations (","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"jf7IBfcAtn"},{"type":"inlineMath","value":"N","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>","key":"LMrtN17pbL"},{"type":"text","value":") and different numbers of knots (","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"RN933lUwgU"},{"type":"inlineMath","value":"K","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>","key":"c6yBLwWI7q"},{"type":"text","value":"). We will explicitly test the ","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"gpIGDOC6kk"},{"type":"strong","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"Natural Spline","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"DwVc0Mv58Z"}],"key":"i4EzztmUOF"},{"type":"text","value":" engine (basis form) and the ","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"rUyGRdWtS1"},{"type":"strong","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"Reinsch","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"diG7z9v9KZ"}],"key":"GOASs5Bc1r"},{"type":"text","value":" engine (when applicable) and the ","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"Otve0BVo9V"},{"type":"strong","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"B-Spline","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"idwAgCJjcd"}],"key":"GwGFaB36Pz"},{"type":"text","value":" engine.","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"FnNbuqeQ0Z"}],"key":"wP23IPqLu4"}],"key":"uqq2HTPRbs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def benchmark_fitters(ns, n_knots=None, engine='reinsch', python=True):\n    results = {'py': [], 'cpp': []}\n    \n    for n in ns:\n        rng = np.random.default_rng(0)\n        x = np.sort(rng.uniform(0, 10, n))\n        y = np.sin(x) + rng.normal(0, 0.1, n)\n        \n        # Pure Python (always basis form natural spline)\n        if python:\n            start = time.time()\n            fitter_py = SplineFitterPy(x, n_knots=n_knots, df=10)\n            fitter_py.fit(y)\n            results['py'].append(time.time() - start)\n\n        try:\n            start = time.time()\n            # Explicitly request engine\n            fitter_cpp = SplineFitter(x, df=10, n_knots=n_knots, engine=engine)\n            fitter_cpp.fit(y)\n            results['cpp'].append(time.time() - start)\n        except ValueError:\n            # Engine might not be compatible (e.g. reinsch with reduced knots)\n            results['cpp'].append(np.nan)\n            \n    return results\n\n# Sizes to test\nns = [100, 500, 1000, 2000, 5000][:4]","key":"FxyWMSSmWN"},{"type":"outputs","id":"_BNexZEauARV7UbiftxIz","children":[],"key":"ENCENg9D29"}],"key":"cyBIN8n4Le"},{"type":"block","children":[{"type":"heading","depth":3,"position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"children":[{"type":"text","value":"1. All Unique X as Knots (K = N)","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"RX04gklZ4q"}],"identifier":"id-1-all-unique-x-as-knots-k-n","label":"1. All Unique X as Knots (K = N)","html_id":"id-1-all-unique-x-as-knots-k-n","implicit":true,"key":"XpFRmcUPg2"},{"type":"paragraph","position":{"start":{"line":77,"column":1},"end":{"line":78,"column":1}},"children":[{"type":"text","value":"When ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"Efcq3yIz3s"},{"type":"inlineMath","value":"N","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>","key":"FYbTEZ360A"},{"type":"text","value":" is small, using all unique ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"bgJ1LJmrr8"},{"type":"inlineMath","value":"x","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>","key":"INeaOh5Znh"},{"type":"text","value":" values as knots is feasible.\nWe compare:","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"Osb6F32dCS"}],"key":"aJ7nlfvXiE"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":79,"column":1},"end":{"line":84,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Pure Python (Natural Spline Basis)","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"MfgZCxqwqt"}],"key":"WzdCBQSXoH"}],"key":"PgrD8EcBkU"},{"type":"listItem","spread":true,"position":{"start":{"line":80,"column":1},"end":{"line":80,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"C++ ","position":{"start":{"line":80,"column":1},"end":{"line":80,"column":1}},"key":"bT2KYbmUGx"},{"type":"inlineCode","value":"engine='natural'","position":{"start":{"line":80,"column":1},"end":{"line":80,"column":1}},"key":"DJS9RYmSNI"},{"type":"text","value":" (Natural Spline Basis)","position":{"start":{"line":80,"column":1},"end":{"line":80,"column":1}},"key":"PiduFyP7cf"}],"key":"xgd5mHqf3f"}],"key":"ZnBOUAp8bq"},{"type":"listItem","spread":true,"position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"C++ ","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"kyfuoTIfs3"},{"type":"inlineCode","value":"engine='reinsch'","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"kBZYS819cu"},{"type":"text","value":" (Reinsch Algorithm - O(N))","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"ABj0IFYYp8"}],"key":"Xt1vWEESLo"}],"key":"njBbrtiVOG"},{"type":"listItem","spread":true,"position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"C++ ","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"SdbMWv6RA3"},{"type":"inlineCode","value":"engine='bspline'","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"AKcAeC8h0F"},{"type":"text","value":" (B-Spline Basis)","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"OJgJSmX3ir"}],"key":"DuR71K91MS"}],"key":"OTZujbI8YH"},{"type":"listItem","spread":true,"position":{"start":{"line":83,"column":1},"end":{"line":84,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"C++ ","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"key":"y9o92upLjm"},{"type":"inlineCode","value":"engine='auto'","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"key":"zkayCdIQhs"},{"type":"text","value":" (Default Selection)","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"key":"UsaxUl2eF2"}],"key":"JmVIkc9AVo"}],"key":"GFjFTlbMSG"}],"key":"JQ6PUbSzwg"}],"key":"szZDul48PS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f\"Benchmarking with ns={ns} (All Knots)...\")\nresults_natural = benchmark_fitters(ns, engine='natural')\nresults_py = results_natural['py']\nresults_natural = results_natural['cpp']\nresults_reinsch = benchmark_fitters(ns, engine='reinsch', python=False)['cpp']\nresults_bspline = benchmark_fitters(ns, engine='bspline', python=False)['cpp']\nresults_auto = benchmark_fitters(ns, engine='auto', python=False)['cpp']\n\nfig, ax = plt.subplots(figsize=(10, 6))\nif SplineFitterPy:\n    ax.plot(ns, results_py, 'o-', label='Pure Python')\nax.plot(ns, results_natural, 's-', label=\"C++ 'natural'\")\nax.plot(ns, results_reinsch, '^-', label=\"C++ 'reinsch'\")\nax.plot(ns, results_bspline, 'd-', label=\"C++ 'bspline'\")\nax.plot(ns, results_auto, 'x--', label=\"C++ 'auto'\")\n\nax.set_xlabel('Number of observations (N)')\nax.set_ylabel('Time (seconds)')\nax.set_title('Speed Comparison (K = N)')\nax.legend()\nax.grid(True)\nax.set_yscale('log')","key":"GEUigbCGcs"},{"type":"outputs","id":"B0gRWV6lz5FMEK68UcbT6","children":[{"type":"output","children":[],"jupyter_data":{"output_type":"stream","name":"stdout","text":"Benchmarking with ns=[100, 500, 1000, 2000] (All Knots)...\n"},"key":"M1jQ8gm9WW"},{"type":"output","children":[],"jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"<Figure size 1000x600 with 1 Axes>","content_type":"text/plain"},"image/png":{"content_type":"image/png","hash":"ca8cbff9d2886ed358ed8ffa78c54ccd","path":"https://jonathan-taylor.github.io/smoothing_spline//build/ca8cbff9d2886ed358ed8ffa78c54ccd.png"}}},"key":"Eoz9iIyv21"}],"key":"o3xIscCYmc"}],"key":"jdmz23XRYJ"},{"type":"block","children":[{"type":"heading","depth":3,"position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"children":[{"type":"text","value":"2. Fixed Number of Knots (K=200)","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"key":"EyHP6VCw9s"}],"identifier":"id-2-fixed-number-of-knots-k-200","label":"2. Fixed Number of Knots (K=200)","html_id":"id-2-fixed-number-of-knots-k-200","implicit":true,"key":"H2vBlzg0lP"},{"type":"paragraph","position":{"start":{"line":112,"column":1},"end":{"line":113,"column":1}},"children":[{"type":"text","value":"In practice, for large ","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"BOMP09QoSO"},{"type":"inlineMath","value":"N","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>","key":"ScBsuCOFuE"},{"type":"text","value":", we often limit the number of knots to a fixed ","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"vQ5DHXdEAo"},{"type":"inlineMath","value":"K \\ll N","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi><mo>≪</mo><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">K \\ll N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7224em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≪</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>","key":"SOgVS8By0q"},{"type":"text","value":".\n","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"XHSwIbH3B9"},{"type":"inlineCode","value":"engine='reinsch'","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"ecG0IAbk6Z"},{"type":"text","value":" is not available here (requires K=N). We compare ","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"cAnifQzfv0"},{"type":"inlineCode","value":"natural","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"MTrpTwruQT"},{"type":"text","value":", ","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"EAgLebaduV"},{"type":"inlineCode","value":"bspline","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"BnCFXEoapg"},{"type":"text","value":" and ","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"a7Qo6r7t6z"},{"type":"inlineCode","value":"auto","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"KXyxhzColo"},{"type":"text","value":".","position":{"start":{"line":112,"column":1},"end":{"line":112,"column":1}},"key":"gXQPohA8JC"}],"key":"pOIMDgBGsU"}],"key":"x71X3wWwUF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ns_large = [100, 500, 1000, 1500, 2000, 5000, 10000, 20000, 30000, 50000]\nK = 200\nprint(f\"Benchmarking with large N and K={K}...\")\nresults_fixed_natural = benchmark_fitters(ns_large, n_knots=K, engine='natural', python=False)['cpp']\nresults_fixed_bspline = benchmark_fitters(ns_large, n_knots=K, engine='bspline', python=False)['cpp']","key":"agTVPFerp9"},{"type":"outputs","id":"4skmuDfY43ZfLAb87LAuZ","children":[{"type":"output","children":[],"jupyter_data":{"output_type":"stream","name":"stdout","text":"Benchmarking with large N and K=200...\n"},"key":"SvI2je5Ueo"},{"type":"output","children":[],"jupyter_data":{"output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mRuntimeError\u001b[0m                              Traceback (most recent call last)\nFile \u001b[0;32m~/work/smoothing_spline/smoothing_spline/smoothing_spline/fitter.py:227\u001b[0m, in \u001b[0;36mSplineFitter._find_lamval_for_df\u001b[0;34m(self, target_df, log10_lam_bounds)\u001b[0m\n\u001b[1;32m    226\u001b[0m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[0;32m--> 227\u001b[0m     lam_scaled \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_cpp_fitter\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43msolve_for_df\u001b[49m\u001b[43m(\u001b[49m\u001b[43mtarget_df\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmin_log\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmax_log\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    228\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m lam_scaled \u001b[38;5;241m*\u001b[39m (\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mx_scale_ \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39m \u001b[38;5;241m3\u001b[39m)\n\n\u001b[0;31mRuntimeError\u001b[0m: Root not bracketed: target DF out of feasible range.\n\nDuring handling of the above exception, another exception occurred:\n\n\u001b[0;31mRuntimeError\u001b[0m                              Traceback (most recent call last)\nCell \u001b[0;32mIn[4], line 4\u001b[0m\n\u001b[1;32m      2\u001b[0m K \u001b[38;5;241m=\u001b[39m \u001b[38;5;241m200\u001b[39m\n\u001b[1;32m      3\u001b[0m \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124mf\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mBenchmarking with large N and K=\u001b[39m\u001b[38;5;132;01m{\u001b[39;00mK\u001b[38;5;132;01m}\u001b[39;00m\u001b[38;5;124m...\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[0;32m----> 4\u001b[0m results_fixed_natural \u001b[38;5;241m=\u001b[39m \u001b[43mbenchmark_fitters\u001b[49m\u001b[43m(\u001b[49m\u001b[43mns_large\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mn_knots\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mK\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mengine\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43mnatural\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mpython\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m)\u001b[49m[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mcpp\u001b[39m\u001b[38;5;124m'\u001b[39m]\n\u001b[1;32m      5\u001b[0m results_fixed_bspline \u001b[38;5;241m=\u001b[39m benchmark_fitters(ns_large, n_knots\u001b[38;5;241m=\u001b[39mK, engine\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mbspline\u001b[39m\u001b[38;5;124m'\u001b[39m, python\u001b[38;5;241m=\u001b[39m\u001b[38;5;28;01mFalse\u001b[39;00m)[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mcpp\u001b[39m\u001b[38;5;124m'\u001b[39m]\n\nCell \u001b[0;32mIn[2], line 19\u001b[0m, in \u001b[0;36mbenchmark_fitters\u001b[0;34m(ns, n_knots, engine, python)\u001b[0m\n\u001b[1;32m     17\u001b[0m start \u001b[38;5;241m=\u001b[39m time\u001b[38;5;241m.\u001b[39mtime()\n\u001b[1;32m     18\u001b[0m \u001b[38;5;66;03m# Explicitly request engine\u001b[39;00m\n\u001b[0;32m---> 19\u001b[0m fitter_cpp \u001b[38;5;241m=\u001b[39m \u001b[43mSplineFitter\u001b[49m\u001b[43m(\u001b[49m\u001b[43mx\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mdf\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;241;43m10\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mn_knots\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mn_knots\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mengine\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mengine\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m     20\u001b[0m fitter_cpp\u001b[38;5;241m.\u001b[39mfit(y)\n\u001b[1;32m     21\u001b[0m results[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mcpp\u001b[39m\u001b[38;5;124m'\u001b[39m]\u001b[38;5;241m.\u001b[39mappend(time\u001b[38;5;241m.\u001b[39mtime() \u001b[38;5;241m-\u001b[39m start)\n\nFile \u001b[0;32m<string>:12\u001b[0m, in \u001b[0;36m__init__\u001b[0;34m(self, x, w, lamval, df, knots, n_knots, order, engine)\u001b[0m\n\nFile \u001b[0;32m~/work/smoothing_spline/smoothing_spline/smoothing_spline/fitter.py:73\u001b[0m, in \u001b[0;36mSplineFitter.__post_init__\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m     71\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_cholesky_cache \u001b[38;5;241m=\u001b[39m {}\n\u001b[1;32m     72\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mdf \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[0;32m---> 73\u001b[0m     \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mlamval \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_find_lamval_for_df\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mdf\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m     74\u001b[0m \u001b[38;5;28;01melif\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mlamval \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[1;32m     75\u001b[0m     \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mlamval \u001b[38;5;241m=\u001b[39m \u001b[38;5;241m0.0\u001b[39m\n\nFile \u001b[0;32m~/work/smoothing_spline/smoothing_spline/smoothing_spline/fitter.py:230\u001b[0m, in \u001b[0;36mSplineFitter._find_lamval_for_df\u001b[0;34m(self, target_df, log10_lam_bounds)\u001b[0m\n\u001b[1;32m    228\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m lam_scaled \u001b[38;5;241m*\u001b[39m (\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mx_scale_ \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39m \u001b[38;5;241m3\u001b[39m)\n\u001b[1;32m    229\u001b[0m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mRuntimeError\u001b[39;00m \u001b[38;5;28;01mas\u001b[39;00m e:\n\u001b[0;32m--> 230\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mRuntimeError\u001b[39;00m(\u001b[38;5;124mf\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mC++ solver failed: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00me\u001b[38;5;132;01m}\u001b[39;00m\u001b[38;5;124m\"\u001b[39m)\n\n\u001b[0;31mRuntimeError\u001b[0m: C++ solver failed: Root not bracketed: target DF out of feasible range.","ename":"RuntimeError","evalue":"C++ solver failed: Root not bracketed: target DF out of feasible range."},"key":"c6M2KezKLJ"}],"key":"oDQz3yG4ZQ"}],"key":"BTQPGr7V4G"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(10, 6))\nax.plot(ns_large, results_fixed_natural, 's-', label=f\"C++ 'natural' (K={K})\")\nax.plot(ns_large, results_fixed_bspline, 'd-', label=f\"C++ 'bspline' (K={K})\")\n\nax.set_xlabel('Number of observations (N)')\nax.set_ylabel('Time (seconds)')\nax.set_title(f'Speed Comparison (Fixed K={K})')\nax.legend()\nax.grid(True)\nax.set_yscale('log')","key":"sddKhEDHAT"},{"type":"outputs","id":"dR1sx7OmX-QHjwMRbJQeI","children":[],"key":"R296NUWFfj"}],"key":"eOvsGBYiFl"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":136,"column":1},"end":{"line":136,"column":1}},"children":[{"type":"text","value":"GCV Solve Performance","position":{"start":{"line":136,"column":1},"end":{"line":136,"column":1}},"key":"XYsAQ7N0Qa"}],"identifier":"gcv-solve-performance","label":"GCV Solve Performance","html_id":"gcv-solve-performance","implicit":true,"key":"GKwsdhj6Wf"},{"type":"paragraph","position":{"start":{"line":138,"column":1},"end":{"line":138,"column":1}},"children":[{"type":"text","value":"Automatic tuning with GCV involves multiple fits (or an optimized path). The C++ extension provides a highly optimized ","position":{"start":{"line":138,"column":1},"end":{"line":138,"column":1}},"key":"Jmig8cOiiu"},{"type":"inlineCode","value":"solve_gcv","position":{"start":{"line":138,"column":1},"end":{"line":138,"column":1}},"key":"wUSX6qULmV"},{"type":"text","value":" method.","position":{"start":{"line":138,"column":1},"end":{"line":138,"column":1}},"key":"k4jzA6Yv5w"}],"key":"KJqVbrkVdm"}],"key":"GQfmAs0MC7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"n = 5000\nK = 200\nrng = np.random.default_rng(0)\nx = np.sort(rng.uniform(0, 10, n))\ny = np.sin(x) + rng.normal(0, 0.1, n)","key":"Z72O0Xbgka"},{"type":"outputs","id":"UeLzhz1IuN_xygw8A1SJ8","children":[],"key":"BAk46xdTnn"}],"key":"ZkvTEXOVCP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%timeit\nfitter = SplineFitter(x, n_knots=K)\nbest_lam = fitter.solve_gcv(y)","key":"c2NRJgObWW"},{"type":"outputs","id":"VXUrOspBpP8PIjMaqaSRX","children":[],"key":"sednql6cZJ"}],"key":"JAHx2lSwmA"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"children":[{"type":"text","value":"Conclusion","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"IU19DANXjw"}],"identifier":"conclusion","label":"Conclusion","html_id":"conclusion","implicit":true,"key":"hUEK7MZivN"},{"type":"paragraph","position":{"start":{"line":157,"column":1},"end":{"line":157,"column":1}},"children":[{"type":"text","value":"The C++ extension provides significant speedups, especially as the number of knots or observations increases. This is due to the efficient matrix operations and optimized algorithms implemented in C++ using the Eigen library.","position":{"start":{"line":157,"column":1},"end":{"line":157,"column":1}},"key":"Pq6ZTz0I6l"}],"key":"GfwHar0f3J"}],"key":"cgosneIzKd"}],"key":"eWc1OAsoCg"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Comparing smoothing_spline with R’s smooth.spline","url":"/compare-r","group":"Smoothing Spline"},"next":{"title":"Boundary Behavior Comparison: smoothing_spline vs scipy","url":"/compare-scipy","group":"Smoothing Spline"}}},"domain":"http://localhost:3000"}